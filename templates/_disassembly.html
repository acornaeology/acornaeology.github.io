{% extends "base.html" %}

{% block title %}{{ title }} â€” acornaeology{% endblock %}
{% block description %}Annotated disassembly of {{ title }}.{% endblock %}
{% block og_url %}https://acornaeology.uk/{{ slug }}/{{ version_id }}.html{% endblock %}

{% block body_attrs %} class="page-disassembly"{% endblock %}

{% block content %}
<h1>{{ title }}</h1>
<p class="version-back"><a href="./">&larr; All {{ name }} versions</a></p>
{% if links %}
<ul class="rom-links">
{% for link in links %}
<li><a href="{{ link.url }}">{% if link.icon == "chip" %}<svg class="link-icon" viewBox="0 0 24 24" aria-hidden="true"><rect x="6" y="4" width="12" height="16" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/><line x1="3" y1="8" x2="6" y2="8" stroke="currentColor" stroke-width="1.5"/><line x1="3" y1="12" x2="6" y2="12" stroke="currentColor" stroke-width="1.5"/><line x1="3" y1="16" x2="6" y2="16" stroke="currentColor" stroke-width="1.5"/><line x1="18" y1="8" x2="21" y2="8" stroke="currentColor" stroke-width="1.5"/><line x1="18" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="1.5"/><line x1="18" y1="16" x2="21" y2="16" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="10" r="1.2" fill="currentColor"/></svg>{% elif link.icon == "github" %}<svg class="link-icon" viewBox="0 0 16 16" aria-hidden="true"><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>{% elif link.icon == "doc" %}<svg class="link-icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="none" stroke="currentColor" stroke-width="1.5" d="M6 2h9l5 5v15H6z"/><polyline fill="none" stroke="currentColor" stroke-width="1.5" points="15,2 15,7 20,7"/><line x1="9" y1="12" x2="17" y2="12" stroke="currentColor" stroke-width="1.5"/><line x1="9" y1="16" x2="15" y2="16" stroke="currentColor" stroke-width="1.5"/></svg>{% endif %}{{ link.label }}</a></li>
{% endfor %}
</ul>
{% endif %}

<div class="disassembly-layout">
{% if subroutines %}
<nav class="subroutine-nav">
    <details open>
        <summary>Subroutines</summary>
        <ul>
        {% for sub in subroutines %}
        {% if sub.name %}
        <li>
            <a href="#addr-{{ '%04X' % sub.addr }}">{{ sub.name }}</a>
            {% if sub.title %}<span class="sub-title">{{ sub.title }}</span>{% endif %}
        </li>
        {% endif %}
        {% endfor %}
        </ul>
    </details>
</nav>
<script>if (matchMedia("(max-width:900px)").matches) document.querySelector(".subroutine-nav details").removeAttribute("open")</script>
{% endif %}

<div class="listing">
{% for section in sections %}
<table{% if section.has_binary_addr %} class="relocated"{% endif %}>
{% for line in section.lines %}
{% if line.banner %}
<tr{% if line.id %} id="{{ line.id }}"{% endif %}>
<td colspan="{{ 3 if section.has_binary_addr else 2 }}">{{ line.html }}</td>
</tr>
{% if section.has_binary_addr %}
<tr class="addr-header"><th>ROM</th><th>Relocated</th><th></th></tr>
{% endif %}
{% else %}
<tr{% if line.id %} id="{{ line.id }}"{% endif %}>
{% if section.has_binary_addr %}
{% if line.binary_addr %}
<td class="addr">{% if line.binary_addr %}<span id="{{ line.binary_addr_id }}"></span><a href="#{{ line.binary_addr_id }}">{{ line.binary_addr }}</a>{% endif %}</td>
<td class="addr runtime-addr">{% if line.addr %}<a href="#{{ line.addr_id }}">{{ line.addr }}</a>{% endif %}</td>
{% else %}
<td class="addr">{% if line.addr %}<a href="#{{ line.addr_id }}">{{ line.addr }}</a>{% endif %}</td>
<td class="addr runtime-addr"></td>
{% endif %}
{% else %}
<td class="addr">{% if line.addr %}<a href="#{{ line.addr_id }}">{{ line.addr }}</a>{% endif %}</td>
{% endif %}
<td>{{ line.html }}</td>
</tr>
{% endif %}
{% endfor %}
</table>
{% endfor %}
</div>
</div>
<script>
(function () {
    var linkIcon = '<svg viewBox="0 0 16 16" aria-hidden="true"><path fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M6.75 9.25a3.25 3.25 0 0 0 4.596.443l1.904-1.904a3.25 3.25 0 0 0-4.596-4.596L7.5 4.347"/><path fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M9.25 6.75a3.25 3.25 0 0 0-4.596-.443L2.75 8.211a3.25 3.25 0 0 0 4.596 4.596L8.5 11.653"/></svg>';
    var checkIcon = '<svg viewBox="0 0 16 16" aria-hidden="true"><path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 8.5 6.5 12 13 4"/></svg>';

    var btn = document.createElement("button");
    btn.className = "copy-link";
    btn.title = "Copy permalink";
    btn.innerHTML = linkIcon;

    var toast = document.createElement("div");
    toast.className = "copy-toast";
    toast.textContent = "Link copied";
    document.body.appendChild(toast);
    var toastTimer = null;

    var currentTd = null;
    var hideTimer = null;

    var listing = document.querySelector(".listing");
    if (!listing) return;

    listing.addEventListener("mouseover", function (e) {
        var a = e.target.closest("td.addr a, td.runtime-addr a");
        if (!a) return;
        var td = a.closest("td");
        if (td === currentTd) return;
        clearTimeout(hideTimer);
        currentTd = td;
        btn.innerHTML = linkIcon;
        td.appendChild(btn);
    });

    listing.addEventListener("mouseout", function (e) {
        var td = e.target.closest("td.addr, td.runtime-addr");
        if (!td) return;
        var related = e.relatedTarget;
        if (related && td.contains(related)) return;
        hideTimer = setTimeout(function () {
            if (btn.parentNode) btn.parentNode.removeChild(btn);
            currentTd = null;
        }, 100);
    });

    btn.addEventListener("mouseenter", function () {
        clearTimeout(hideTimer);
    });

    btn.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        var td = btn.closest("td");
        var a = td && td.querySelector("a[href^='#']");
        if (!a) return;
        var url = location.origin + location.pathname + a.getAttribute("href");
        navigator.clipboard.writeText(url).then(function () {
            btn.innerHTML = checkIcon;
            setTimeout(function () { btn.innerHTML = linkIcon; }, 1500);
            clearTimeout(toastTimer);
            toast.classList.add("visible");
            toastTimer = setTimeout(function () {
                toast.classList.remove("visible");
            }, 1500);
        });
    });
})();
</script>
<button class="back-to-top" aria-label="Back to top"><svg viewBox="0 0 16 16" aria-hidden="true"><path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M3 10 8 5 13 10"/></svg></button>
<script>
(function () {
    var btn = document.querySelector(".back-to-top");
    if (!btn) return;
    window.addEventListener("scroll", function () {
        btn.classList.toggle("visible", window.scrollY > window.innerHeight);
    }, {passive: true});
    btn.addEventListener("click", function () {
        window.scrollTo({top: 0, behavior: "smooth"});
    });
})();
</script>
{% endblock %}
